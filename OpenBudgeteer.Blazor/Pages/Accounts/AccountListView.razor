@inject CurrencyProvider CurrencyProvider
@inject DrawerService DrawerService

<MudPaper Class="flex-grow-1 mud-background" Elevation="0" MinHeight="55px" MinWidth="250px" MaxWidth="800px">
    <MudStack Class="d-flex">
        <Condition Evaluation="@(_uniqueCurrencies.Length > 0)">
            <Match>
                <MudButtonGroup Class="align-self-end" OverrideStyles="false">
                    <Iteration Items="@_uniqueCurrencies" Context="currency">
                        <MudButton Color="Color.Primary" Size="Size.Small" OnClick="@(() => SelectCurrencyAccounts(currency))"
                                   Variant="@(currency == SelectedCurrency?.IsoCode ? Variant.Filled : Variant.Outlined)"
                                   Disabled="@(_uniqueCurrencies.Length < 2)">
                            @currency
                        </MudButton>
                    </Iteration>
                </MudButtonGroup>
            </Match>
        </Condition>
        <MudExpansionPanels MultiExpansion="true" Elevation="3">
            <Iteration Items="@CurrencyAccounts">
                <MudExpansionPanel Expanded="@ExpandedPanels.Contains(context.DisplayName)" ExpandedChanged="@((isExpanded) => Expanded(context.DisplayName, isExpanded))">
                    <TitleContent>
                        <MudStack Row="true" Class="d-flex flex-wrap">
                            <MudIcon Icon="@context.Icon" class="mr-2"></MudIcon>
                            <MudText Class="header-text" Typo="Typo.h6">@context.DisplayName</MudText>
                            <Condition Evaluation="@(ExpandedPanels.Contains(context.DisplayName) is false)">
                                <Match>
                                    <MudHidden Breakpoint="Breakpoint.SmAndDown">
                                        <MudSpacer />
                                        <MudText Class="mr-n2 header-text" HtmlTag="span" Typo="Typo.h6">
                                            @context.Accounts.Sum(x => GetDisplayBalance(x)).ToString("C", _customCulture)
                                        </MudText>
                                        <MudText Class="mr-4 align-self-end" HtmlTag="span" Typo="Typo.caption">
                                            @context.Accounts.First().Currency!.IsoCode
                                        </MudText>
                                    </MudHidden>
                                </Match>
                            </Condition>
                        </MudStack>
                    </TitleContent>
                    <ChildContent>
                        <Iteration Items="@context.Accounts" Context="account">
                            <MudStack Row Class="flex-wrap flex-grow-1" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <MudStack Row Class="flex-grow-1" AlignItems="AlignItems.Center" Style="min-width:225px;">
                                    <Condition Evaluation="@(!account.IsActive)">
                                        <Match>
                                            <MudIcon Icon="@Icons.Material.Filled.DisabledVisible" Size="Size.Small" />
                                        </Match>
                                        <NotMatch>
                                            <Condition Evaluation="@(string.IsNullOrEmpty(account.Alias))">
                                                <Match>
                                                    <MudIcon Size="Size.Small" />
                                                </Match>
                                                <NotMatch>
                                                    <MudTooltip Text="@account.Alias" Placement="Placement.Right">
                                                        <MudBadge Color="@GetStatusColor(account)" Visible="@ShowBadge(account)" Dot>
                                                            <MudAvatar Color="Color.Primary" Size="Size.Small">@account.Alias!.ToUpper()[0]</MudAvatar>
                                                        </MudBadge>
                                                    </MudTooltip>
                                                </NotMatch>
                                            </Condition>
                                        </NotMatch>
                                    </Condition>
                                    <MudTooltip Text="@account.SubType" Placement="Placement.Right">
                                        <MudText Class="pl-4" HtmlTag="span" Typo="Typo.subtitle1">@account.Name</MudText>
                                    </MudTooltip>
                                </MudStack>
                                <MudStack Row Class="flex-grow-1" AlignItems="AlignItems.Center" Justify="Justify.FlexStart" StretchItems="StretchItems.Start">
                                    <MudBreakpointProvider OnBreakpointChanged="@SetJustify">
                                        <MudStack Row AlignItems="AlignItems.Center" Justify="@JustifyStartOrEnd" Spacing="0">
                                            <MudText Class="pl-12" HtmlTag="span" Typo="Typo.subtitle1">@(GetDisplayBalance(account).ToString("C", _customCulture))</MudText>
                                            <MudText Class="pl-1 pt-1" HtmlTag="span" Typo="Typo.caption">@account.Currency!.IsoCode</MudText>
                                        </MudStack>
                                        <MudMenu Class="align-self-end mr-n3" Icon="@Icons.Material.Filled.MoreVert" Dense="true"
                                                 AnchorOrigin="Origin.CenterLeft" TransformOrigin="Origin.TopRight">
                                            <Condition Evaluation="@(account.AccountType == AccountType.Deposit)">
                                                <Match>
                                                    <MudMenuItem Icon="@Icons.Material.Filled.SwapHoriz" IconSize="Size.Small" OnClick="@(() => AccountTransfer(account))">Transfer</MudMenuItem>
                                                </Match>
                                            </Condition>
                                            <Condition Evaluation="@(account.AccountType == AccountType.Credit)">
                                                <Match>
                                                    <MudMenuItem Icon="@Icons.Material.Filled.Payments" IconSize="Size.Small" OnClick="@(() => AccountPayment(account))">Pay</MudMenuItem>
                                                </Match>
                                            </Condition>
                                            <MudMenuItem Icon="@Icons.Material.Filled.Edit" IconSize="Size.Small" OnClick="@(() => EditAccount(account))">Edit</MudMenuItem>
                                            <MudMenuItem Icon="@Icons.Material.Filled.Delete" IconSize="Size.Small" IconColor="Color.Error" OnClick="@(() => DeleteAccount(account))">Delete</MudMenuItem>
                                        </MudMenu>
                                    </MudBreakpointProvider>
                                </MudStack>
                            </MudStack>
                        </Iteration>
                    </ChildContent>
                </MudExpansionPanel>
            </Iteration>
        </MudExpansionPanels>
    </MudStack>
</MudPaper>
<Condition Evaluation="SelectedCurrency is not null">
    <Match>
        <BalanceSummary Currency="@SelectedCurrency" Savings="@SavingsSummary()" Loans="LoanSummary()" NetWorth="NetWorth()" />
    </Match>
</Condition>

@code {
    private Justify JustifyStartOrEnd = Justify.FlexEnd;
    private string DefaultCurrency => CurrencyProvider.DefaultCurrency.IsoCode;

    [CascadingParameter] Guid OwnerId { get; set; }

    [EditorRequired][Parameter] public EventCallback<AccountDetailViewModel> OnEditAccount { get; set; }
    [EditorRequired][Parameter] public EventCallback<AccountDetailViewModel> OnDeleteAccount { get; set; }
    [EditorRequired][Parameter] public required Dictionary<string, AccountListModel> Accounts { get; set; }

    [Parameter] public Currency? SelectedCurrency { get; set; }

    private Dictionary<string, List<KeyValuePair<string, AccountListModel>>> AccountsGroupedByType { get; set; } = [];

    private AccountListModel[] CurrencyAccounts { get; set; } = [];

    private HashSet<string> ExpandedPanels { get; set; } = [];

    private CultureInfo? _customCulture;

    private string[] _uniqueCurrencies = [];

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        AccountsGroupedByType = Accounts
            .Where(kvp => kvp.Value.Accounts.Any())
            .ToDictionary(
                kvp => kvp.Key,
                kvp => kvp.Value.Accounts
                    .GroupBy(account => account.Currency!.IsoCode)
                    .Where(group => group.Any())
                    .Select(group => new KeyValuePair<string, AccountListModel>(
                        group.Key,
                        new AccountListModel(kvp.Value.Type, kvp.Value.DisplayName, kvp.Value.Icon)
                            {
                                Accounts = group.ToList()
                            }
                    ))
                    .ToList()
            );

        _uniqueCurrencies = AccountsGroupedByType.Values
            .SelectMany(accountLists => accountLists.Select(accountList => accountList.Key))
            .Distinct()
            .Order()
            .ToArray();

        if (_uniqueCurrencies.Length == 0) return;

        var currencyCode = SelectedCurrency?.IsoCode ?? DefaultCurrency;

        if (!_uniqueCurrencies.Contains(currencyCode)) currencyCode = _uniqueCurrencies[0];

        SelectCurrencyAccounts(currencyCode);

        _customCulture = new CultureInfo(CultureInfo.CurrentCulture.Name)
        {
            NumberFormat =
            {
                CurrencySymbol = SelectedCurrency!.Symbol,
                CurrencyDecimalDigits = 0
            }
        };
    }

    private decimal GetDisplayBalance(AccountDetailViewModel account)
    {
        return account.SubType is SubType.Loan.Borrowing ? -1 * account.Balance : account.Balance;
    }

    private void SetJustify(Breakpoint breakpoint)
    {
        JustifyStartOrEnd = breakpoint switch
        {
            Breakpoint.Xs => Justify.FlexStart, 
            _ => Justify.FlexEnd
        };
    }

    private bool ShowBadge(AccountDetailViewModel accountDetail)
    {
        if (accountDetail.AccountType != AccountType.Credit) return false;

        var currentDate = DateTime.Now.Date;
        var statementDate = new DateTime(currentDate.Year, currentDate.Month, accountDetail.EffectiveDate!.Value.Day);

        return statementDate >= currentDate; //TODO - check if transactions before effective date are paid
    }

    private Color GetStatusColor(AccountDetailViewModel accountDetail)
    {
        if (accountDetail.AccountType != AccountType.Credit) return Color.Default;

        var currentDate = DateTime.Now.Date;
        var statementDate = new DateTime(currentDate.Year, currentDate.Month, accountDetail.EffectiveDate!.Value.Day);

        if (statementDate < currentDate) return Color.Default;

        if (statementDate >= currentDate.Subtract(TimeSpan.FromDays(5))) return Color.Info;

        if (statementDate.AddDays(25) >= currentDate.Subtract(TimeSpan.FromDays(5))) return Color.Warning;

        return Color.Error;
    }

    private void Expanded(string key, bool isExpanded) => _ = isExpanded ? ExpandedPanels.Add(key) : ExpandedPanels.Remove(key);

    private void SelectCurrencyAccounts(string currency)
    {
        ExpandedPanels.Clear();

        CurrencyAccounts = AccountsGroupedByType.Where(group => group.Value.Any(currencyGroup => currencyGroup.Key == currency))
                                                .Select(group => group.Value.First(currencyGroup => currencyGroup.Key == currency).Value)
                                                .ToArray();

        if (CurrencyAccounts.Length > 0)
            SelectedCurrency = CurrencyAccounts[0].Accounts[0].Currency;
    }

    private void AccountTransfer(AccountDetailViewModel account)
    {
        //TODO - account transfer
    }

    private void AccountPayment(AccountDetailViewModel account)
    {
        //TODO - account payment
    }

    private async Task DeleteAccount(AccountDetailViewModel account)
    {
        await OnDeleteAccount.InvokeAsync(account);
    }

    private async Task EditAccount(AccountDetailViewModel account)
    {
        await OnEditAccount.InvokeAsync(account);
    }

    private BalanceModel SavingsSummary() => new("I Have", GetBalance(BalanceType.Asset), "I Owe", GetBalance(BalanceType.Liability))
    {
        Amount = (lineOne, lineTwo) => lineOne - lineTwo,
        BarMax = (lineOne, lineTwo) => lineOne + lineTwo,
        BarValue = (lineOne, _) => lineOne
    };

    private BalanceModel LoanSummary()
    {
        var payable = GetBalance(BalanceType.Payable) * -1;
        var payableLimit = GetLimit(BalanceType.Payable);
        var receivableLimit = GetLimit(BalanceType.Receivable);

        return new("I Owe", payable == 0 ? 0 : payable, "I am Owed", GetBalance(BalanceType.Receivable))
        {
            Amount = (lineOne, _) => lineOne,
            BarMax = (_, _) => payableLimit + receivableLimit,
            BarValue = (lineOne, lineTwo) => (payableLimit - lineOne) + (receivableLimit - lineTwo)
        };
    }

    private BalanceModel NetWorth()
    {
        var assets = GetBalance(BalanceType.Asset) + GetBalance(BalanceType.Deferred) + GetLimit(BalanceType.Receivable);
        var liabilities = GetBalance(BalanceType.Liability) + (GetBalance(BalanceType.Payable) * -1);

        return new("I Have", assets, "I Owe", liabilities)
        {
            Amount = (_, _) => assets - liabilities,
            BarMax = (_, _) => assets,
            BarValue = (_, _) => assets - liabilities
        };
    }

    private double GetBalance(BalanceType type) => CurrencyAccounts
        .Where(model => model.Type == type)
        .SelectMany(model => model.Accounts)
        .Sum(account => (double)account.Balance);

    private double GetLimit(BalanceType type) => CurrencyAccounts
        .Where(model => model.Type == type)
        .SelectMany(model => model.Accounts)
        .Sum(account => (double)(account.In + account.Out));
}

<style>
    .header-text {
        line-height: 1.4 !important;
        align-self: center !important;
        font-size: 1.1rem !important;
        letter-spacing: 0.025em !important;
    }
</style>

